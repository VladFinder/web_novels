<template>
  <div class="calendar-container">
    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
    <button class="back-btn" @click="$emit('back')">–ù–∞–∑–∞–¥</button>
    
    <div class="calendar">
      <div class="calendar-header">
        <button @click="previousMonth" class="nav-btn">&lt;</button>
        <h2>{{ currentMonthName }} {{ currentYear }}</h2>
        <button @click="nextMonth" class="nav-btn">&gt;</button>
      </div>
      
      <div class="weekdays">
        <div v-for="day in weekdays" :key="day" class="weekday">{{ day }}</div>
      </div>
      
      <div class="calendar-grid">
        <div 
          v-for="day in calendarDays" 
          :key="day.date" 
          class="calendar-day"
          :class="{ 
            'other-month': !day.isCurrentMonth,
            'today': day.isToday,
            'has-emotion': day.emotion
          }"
          @click="showEmotionDetails(day)"
        >
          <span class="date">{{ day.dayNumber }}</span>
          <img 
            v-if="day.emotion" 
            :src="getMiniEmotionIcon(day.emotion)" 
            :alt="getEmotionName(day.emotion)"
            class="emotion-icon-mini"
            @error="handleImageError"
            @load="handleImageLoad"
          >
          <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –º–∏–Ω–∏-–∏–∫–æ–Ω–æ–∫ -->
          <div v-if="day.emotion" style="font-size: 8px; color: blue;">{{ day.emotion }}</div>
        </div>
      </div>
    </div>
    
    <!-- –°–µ–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –º—ã—Å–ª–µ–π -->
    <!-- <div class="thoughts-section">
      <h3>–ó–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–∏</h3>
      <div class="thought-input-container">
        <textarea 
          v-model="dailyThought"
          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –º—ã—Å–ª–∏ –æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º –¥–Ω–µ..."
          class="thought-textarea"
          rows="4"
        ></textarea>
        <button @click="saveThought" class="save-thought-btn" :disabled="isSavingThought">
          {{ isSavingThought ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–ó–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–∏' }}
        </button>
      </div>
      <p v-if="thoughtSaved" class="thought-saved">–ú—ã—Å–ª–∏ –∑–∞–ø–∏—Å–∞–Ω—ã!</p>
    </div> -->
    
    <!-- –°–µ–∫—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫ -->
    <div class="notes-section">
      <h3></h3>
      <div class="note-input-container">
      <textarea 
        v-model="dailyNote"
        placeholder="–ù–∞–ø–∏—à–µ—à—å –ø–∞—Ä—É —Å–ª–æ–≤ –æ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º –¥–Ω–µ?"
          class="note-textarea"
          rows="4"
      ></textarea>
        <button @click="saveNote" class="save-note-btn" :disabled="isSavingNote">
          {{ isSavingNote ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É' }}
        </button>
      </div>
      <p v-if="noteSaved" class="note-saved">–í–∞—à–∏ –º—ã—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</p>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ —ç–º–æ—Ü–∏–∏ -->
    <div v-if="selectedDay" class="emotion-modal" @click="closeModal">
      <div class="modal-content" @click.stop>
        <h3>{{ formatDate(selectedDay.date) }}</h3>
        <div class="emotion-details">
          <img :src="getEmotionIcon(selectedDay.emotion)" :alt="getEmotionName(selectedDay.emotion)" class="emotion-icon-large">
          <p class="emotion-name">{{ getEmotionName(selectedDay.emotion) }}</p>
          <p v-if="selectedDay.username" class="username">@{{ selectedDay.username }}</p>
          <div v-if="selectedDay.note" class="note-display">
            <h4>–ó–∞–º–µ—Ç–∫–∞:</h4>
            <p class="emotion-note">{{ selectedDay.note }}</p>
          </div>
          <div v-if="selectedDay.thoughts && selectedDay.thoughts.length > 0" class="thoughts-display">
            <h4>–ó–∞–º–µ—Ç–∫–∏ –∑–∞ –¥–µ–Ω—å:</h4>
            <div v-for="thought in selectedDay.thoughts" :key="thought.id" class="thought-item">
              <p class="thought-text">{{ thought.text }}</p>
              <p class="thought-time">{{ formatTime(thought.timestamp) }}</p>
            </div>
          </div>
          <!-- –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É -->
          <div class="modal-thought-input">
            <textarea v-model="modalThought" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É..." rows="2"></textarea>
            <button @click="addModalThought" :disabled="isSavingModalThought">{{ isSavingModalThought ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É' }}</button>
          </div>
          <p v-if="modalThoughtSaved" class="thought-saved">–ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!</p>
        </div>
        <button @click="closeModal" class="close-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>
</template>

<script>
import { jsonStorageService } from '../services/jsonStorageService'
import { getTelegramUserId } from '../utils/telegram'

export default {
  name: 'EmotionCalendar',
  data() {
    return {
      currentDate: new Date(),
      emotions: [],
      selectedDay: null,
      weekdays: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
      emotionNames: {
        1: '–†–∞–¥–æ—Å—Ç–Ω–æ',
        2: '–ì—Ä—É—Å—Ç–Ω–æ', 
        3: '–°–ø–æ–∫–æ–π–Ω–æ',
        4: '–¢—Ä–µ–≤–æ–∂–Ω–æ',
        5: '–†–∞–∑–¥—Ä–∞–∂—ë–Ω–Ω–æ',
        6: '–ú–µ—á—Ç–∞—Ç–µ–ª—å–Ω–æ'
      },
      dailyNote: '',
      isSavingNote: false,
      noteSaved: false,
      dailyThought: '',
      isSavingThought: false,
      thoughtSaved: false,
      modalThought: '',
      isSavingModalThought: false,
      modalThoughtSaved: false
    }
  },
  computed: {
    currentMonthName() {
      const months = [
        '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
      ]
      return months[this.currentDate.getMonth()]
    },
    currentYear() {
      return this.currentDate.getFullYear()
    },
    calendarDays() {
      const year = this.currentDate.getFullYear()
      const month = this.currentDate.getMonth()
      
      console.log('üîç –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è:', year, month)
      console.log('üîç –¢–µ–∫—É—â–∏–µ —ç–º–æ—Ü–∏–∏:', this.emotions)
      
      // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
      const firstDay = new Date(year, month, 1)
      // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
      const lastDay = new Date(year, month + 1, 0)
      
      // –ù–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
      const startDate = new Date(firstDay)
      const dayOfWeek = firstDay.getDay()
      const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1
      startDate.setDate(firstDay.getDate() - daysToSubtract)
      
      const days = []
      const today = new Date()
      today.setHours(0, 0, 0, 0)
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 42 –¥–Ω—è (6 –Ω–µ–¥–µ–ª—å)
      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate)
        date.setDate(startDate.getDate() + i)
        
        const dateStr = date.toISOString().split('T')[0]
        const emotion = this.getEmotionForDate(dateStr)
        
        const dayData = {
          date: dateStr,
          dayNumber: date.getDate(),
          isCurrentMonth: date.getMonth() === month,
          isToday: date.getTime() === today.getTime(),
          emotion: emotion ? emotion.emotion : null,
          note: emotion ? emotion.note : null,
          timestamp: emotion ? emotion.timestamp : null
        }
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞—Ç
        if (date.getDate() === 21 || date.getDate() === 22) {
          console.log('üîç –î–µ–Ω—å', date.getDate(), '–¥–∞—Ç–∞:', dateStr, '—ç–º–æ—Ü–∏—è:', emotion ? emotion.emotion : '–Ω–µ—Ç')
        }
        
        days.push(dayData)
      }
      
      console.log('üîç –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –¥–Ω–µ–π:', days.length)
      const daysWithEmotions = days.filter(day => day.emotion)
      console.log('üîç –î–Ω–µ–π —Å —ç–º–æ—Ü–∏—è–º–∏:', daysWithEmotions.length)
      
      return days
    }
  },
  async mounted() {
    console.log('üîç EmotionCalendar mounted')
    console.log('üîç –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —ç–º–æ—Ü–∏–π')
    await this.loadEmotions()
    console.log('üîç –≠–º–æ—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≥–æ—Ç–æ–≤')
  },
  methods: {
    async loadEmotions() {
      try {
        let telegramId = getTelegramUserId()
        if (!telegramId) {
          console.warn('Telegram ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π ID')
          // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π debug ID
          telegramId = 'debug_user_1750544735820'
        }
        
        console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–º–æ—Ü–∏–∏ –¥–ª—è ID:', telegramId)
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–º–æ—Ü–∏–∏ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        const startDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1)
        const endDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0)
        
        console.log('üîç –ü–µ—Ä–∏–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏:', startDate.toISOString(), '–¥–æ', endDate.toISOString())
        
        this.emotions = await jsonStorageService.getUserEmotions(telegramId, startDate, endDate)
        console.log('üîç –ó–∞–≥—Ä—É–∂–µ–Ω—ã —ç–º–æ—Ü–∏–∏:', this.emotions)
        console.log('üîç –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ—Ü–∏–π:', this.emotions.length)
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç–º–æ—Ü–∏–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã
        this.emotions.forEach(emotion => {
          console.log('üîç –≠–º–æ—Ü–∏—è –Ω–∞', emotion.date, ':', emotion.emotion)
        })
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–º–æ—Ü–∏–π:', error)
      }
    },
    
    getEmotionForDate(dateStr) {
      const emotion = this.emotions.find(emotion => emotion.date === dateStr)
      console.log('üîç –ü–æ–∏—Å–∫ —ç–º–æ—Ü–∏–∏ –¥–ª—è –¥–∞—Ç—ã', dateStr, ':', emotion)
      return emotion
    },
    
    getEmotionIcon(emotionId) {
      const iconMap = {
        1: require('../assets/emotions/joy.png'),
        2: require('../assets/emotions/sadness.png'),
        3: require('../assets/emotions/calm.png'),
        4: require('../assets/emotions/anxiety.png'),
        5: require('../assets/emotions/irritation.png'),
        6: require('../assets/emotions/dreaminess.png')
      }
      return iconMap[emotionId] || ''
    },
    
    getEmotionName(emotionId) {
      return this.emotionNames[emotionId] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    },
    
    async showEmotionDetails(day) {
      console.log('üîç showEmotionDetails –≤—ã–∑–≤–∞–Ω –¥–ª—è –¥–Ω—è:', day)
      console.log('üîç –î–µ–Ω—å –º–µ—Å—è—Ü–∞:', day.dayNumber, '–î–∞—Ç–∞:', day.date)
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –º—ã—Å–ª–∏ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
      try {
        let telegramId = getTelegramUserId()
        if (!telegramId) {
          telegramId = 'debug_user_1750544735820'
        }
        
        console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –º—ã—Å–ª–∏ –¥–ª—è –¥–∞—Ç—ã:', day.date)
        day.thoughts = await jsonStorageService.getThoughtsByDate(telegramId, day.date)
        console.log('üîç –ó–∞–≥—Ä—É–∂–µ–Ω—ã –º—ã—Å–ª–∏:', day.thoughts)
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–º–æ—Ü–∏—é –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
        const emotionData = await jsonStorageService.getEmotionByDate(telegramId, day.date)
        console.log('üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —ç–º–æ—Ü–∏–∏:', emotionData)
        
        if (emotionData) {
          day.emotion = emotionData.emotion
          day.username = emotionData.username
          day.note = emotionData.note
          console.log('üîç –≠–º–æ—Ü–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', day.emotion, '–ó–∞–º–µ—Ç–∫–∞:', day.note)
        }
        
        this.selectedDay = day
        console.log('üîç –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ –¥–ª—è –¥–Ω—è:', this.selectedDay)
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error)
        // –í—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        this.selectedDay = day
      }
    },
    
    closeModal() {
      this.selectedDay = null
    },
    
    formatDate(dateStr) {
      const date = new Date(dateStr)
      const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'long'
      }
      return date.toLocaleDateString('ru-RU', options)
    },
    
    formatTime(timestamp) {
      const date = new Date(timestamp)
      const options = { 
        hour: 'numeric', 
        minute: 'numeric'
      }
      return date.toLocaleTimeString('ru-RU', options)
    },
    
    previousMonth() {
      this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1)
      this.loadEmotions()
    },
    
    nextMonth() {
      this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1)
      this.loadEmotions()
    },
    
    async saveNote() {
      this.isSavingNote = true
      this.noteSaved = false
      
      try {
        let telegramId = getTelegramUserId()
        if (!telegramId) {
          telegramId = 'debug_user_1750544735820'
        }
        
        console.log('üîç saveNote –≤—ã–∑–≤–∞–Ω')
        console.log('üîç dailyNote:', this.dailyNote)
        
        if (!this.dailyNote.trim()) {
          console.log('üîç –ü—É—Å—Ç–∞—è –∑–∞–º–µ—Ç–∫–∞, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º')
          return
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç–º–æ—Ü–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
        const today = new Date().toISOString().split('T')[0]
        const todayEmotion = await jsonStorageService.getEmotionByDate(telegramId, today)
        
        if (!todayEmotion) {
          throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ—Ü–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è')
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–º–µ—Ç–∫—É –∫–∞–∫ –º—ã—Å–ª—å (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–ª–∞—Å—å)
        const result = await jsonStorageService.saveThought(telegramId, this.dailyNote, today)
        console.log('üîç –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:', result)
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        await this.loadEmotions()
        
        this.dailyNote = ''
        this.noteSaved = true
        
        console.log('üîç –ó–∞–º–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞')
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          this.noteSaved = false
        }, 3000)
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:', error)
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏: ${error.message}`)
      } finally {
        this.isSavingNote = false
      }
    },
    
    async saveThought() {
      console.log('üîç saveThought –≤—ã–∑–≤–∞–Ω')
      console.log('üîç dailyThought:', this.dailyThought)
      
      if (!this.dailyThought.trim()) {
        console.log('üîç –ü—É—Å—Ç–∞—è –º—ã—Å–ª—å, –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º')
        return
      }
      
      this.isSavingThought = true
      this.thoughtSaved = false
      
      try {
        let telegramId = getTelegramUserId()
        if (!telegramId) {
          telegramId = 'debug_user_1750544735820'
        }
        
        console.log('üîç –°–æ—Ö—Ä–∞–Ω—è–µ–º –º—ã—Å–ª—å –¥–ª—è ID:', telegramId)
        console.log('üîç –¢–µ–∫—Å—Ç –º—ã—Å–ª–∏:', this.dailyThought)
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º—ã—Å–ª–∏
        const result = await jsonStorageService.saveThought(telegramId, this.dailyThought)
        console.log('üîç –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result)
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        await this.loadEmotions()
        
        this.dailyThought = ''
        this.thoughtSaved = true
        
        console.log('üîç –ú—ã—Å–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞')
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
          this.thoughtSaved = false
        }, 3000)
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º—ã—Å–ª–µ–π:', error)
        alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º—ã—Å–ª–µ–π: ${error.message}`)
      } finally {
        this.isSavingThought = false
      }
    },
    
    getMiniEmotionIcon(emotionId) {
      const miniIconMap = {
        1: require('../assets/emotions/mini_joy.png'),
        2: require('../assets/emotions/mini_sadness.png'),
        3: require('../assets/emotions/mini_calm.png'),
        4: require('../assets/emotions/mini_anxiety.png'),
        5: require('../assets/emotions/mini_irritation.png'),
        6: require('../assets/emotions/mini_dreaminess.png')
      }
      return miniIconMap[emotionId] || ''
    },
    
    async addModalThought() {
      if (!this.modalThought.trim()) return;
      this.isSavingModalThought = true;
      try {
        let telegramId = getTelegramUserId();
        if (!telegramId) {
          telegramId = 'debug_user_1750544735820';
        }
        await jsonStorageService.saveThought(telegramId, this.modalThought, this.selectedDay.date);
        // –û–±–Ω–æ–≤–∏—Ç—å –º—ã—Å–ª–∏ –≤ –º–æ–¥–∞–ª–∫–µ
        this.selectedDay.thoughts = await jsonStorageService.getThoughtsByDate(telegramId, this.selectedDay.date);
        this.modalThought = '';
        this.modalThoughtSaved = true;
        setTimeout(() => { this.modalThoughtSaved = false; }, 2000);
      } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏: ' + e.message);
      } finally {
        this.isSavingModalThought = false;
      }
    },
    
    handleImageError(event) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', event.target.src)
    },
    
    handleImageLoad(event) {
      console.log('üîç –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', event.target.src)
    }
  }
}
</script>

<style scoped>
.back-btn {
  align-self: flex-start;
  margin-bottom: 20px;
  padding: 10px 20px;
  border-radius: 8px;
  border: none;
  background: rgba(255, 255, 255, 0.3);
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}

.back-btn:hover {
  background: rgba(255, 255, 255, 0.5);
  transform: translateY(-2px);
}

.calendar-container {
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;
  min-height: 100vh;
  overflow-y: auto;
}

.calendar {
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  padding: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.calendar-header h2 {
  margin: 0;
  font-family: 'Mulish', sans-serif;
  font-size: 24px;
  color: #333;
}

.nav-btn {
  background: rgba(255, 255, 255, 0.3);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 18px;
  cursor: pointer;
  transition: all 0.2s;
}

.nav-btn:hover {
  background: rgba(255, 255, 255, 0.5);
  transform: scale(1.1);
}

.weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 10px;
  margin-bottom: 10px;
}

.weekday {
  text-align: center;
  font-weight: bold;
  color: #666;
  font-size: 14px;
  padding: 10px 0;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
  background: rgba(255, 255, 255, 0.1);
}

.calendar-day:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.05);
}

.calendar-day.other-month {
  opacity: 0.3;
}

.calendar-day.today {
  background: rgba(255, 193, 7, 0.3);
  border: 2px solid #ffc107;
}

.calendar-day.has-emotion {
  background: rgba(76, 175, 80, 0.2);
  border: 2px solid #4caf50;
}

.calendar-day .date {
  font-size: 16px;
  font-weight: bold;
  color: #333;
  margin-bottom: 4px;
}

.emotion-icon-mini {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  object-fit: cover;
  margin-top: 2px;
  transition: transform 0.2s;
}

.calendar-day:hover .emotion-icon-mini {
  transform: scale(1.2);
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.emotion-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  padding: 30px;
  border-radius: 20px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  max-height: 80vh;
  overflow-y: auto;
}

.modal-content h3 {
  margin: 0 0 20px 0;
  font-family: 'Mulish', sans-serif;
  color: #333;
  font-size: 20px;
}

.emotion-details {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 30px;
}

.emotion-icon-large {
  width: 120px;
  height: 120px;
  border-radius: 20px;
  object-fit: cover;
  margin-bottom: 15px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

.emotion-name {
  font-size: 24px;
  font-weight: bold;
  margin: 0 0 15px 0;
  color: #333;
  font-family: 'Mulish', sans-serif;
}

.emotion-note {
  text-align: center;
  color: #666;
  font-style: italic;
  margin: 0;
  line-height: 1.5;
}

.close-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.close-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
}

/* –°–µ–∫—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫ */
.notes-section {
  margin-top: 20px;
  padding: 20px;
  background: rgba(0, 255, 0, 0.1);
  border: 2px solid green;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.notes-section h3 {
  color: green;
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 15px;
  text-align: center;
}

.note-input-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 20px;
}

.note-textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
  margin-bottom: 10px;
}

.save-note-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.save-note-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
}

.note-saved {
  margin-top: 10px;
  color: #4caf50;
  font-weight: bold;
}

/* –°–µ–∫—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫ */
.note-display {
  margin-top: 20px;
  text-align: left;
}

.note-display h4 {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
}

/* –°–µ–∫—Ü–∏—è –∑–∞–ø–∏—Å–∏ –º—ã—Å–ª–µ–π */
.thoughts-section {
  margin-top: 20px;
  padding: 20px;
  background: rgba(255, 0, 0, 0.1);
  border: 2px solid red;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.thoughts-section h3 {
  color: red;
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 15px;
  text-align: center;
}

.thought-input-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 20px;
}

.thought-textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ccc;
  border-radius: 10px;
  margin-bottom: 10px;
}

.save-thought-btn {
  background: linear-gradient(135deg, #ff6b6b, #ee5a52);
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 16px;
  font-weight: bold;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.save-thought-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
}

.thought-saved {
  margin-top: 10px;
  color: #4caf50;
  font-weight: bold;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.thoughts-display {
  margin-top: 20px;
  text-align: left;
}

.thought-item {
  margin-bottom: 10px;
}

.thought-text {
  font-size: 16px;
  font-weight: bold;
  color: #333;
}

.thought-time {
  font-size: 14px;
  color: #666;
  font-style: italic;
}

.modal-thought-input {
  margin-top: 15px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.modal-thought-input textarea {
  width: 100%;
  border-radius: 8px;
  border: 1px solid #ccc;
  padding: 6px;
  resize: none;
}

.modal-thought-input button {
  align-self: flex-end;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 8px 18px;
  border-radius: 16px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  font-family: 'Mulish', sans-serif;
  transition: all 0.2s;
}

.modal-thought-input button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>
